define ("qtype_recordrtc/avrecording",["core/log","core/modal_factory"],function(a,b){function c(){if(!(navigator.mediaDevices&&window.MediaRecorder)){return"nowebrtc"}if(!("https:"===location.protocol||-1!==location.host.indexOf("localhost"))){return"nothttps"}return"ok"}function d(b,c,d,e,f,g,h,i){var E=this,F=null,G=null,H=[],I=0,J=0,K=0;e.addEventListener("click",function(b){a.debug("Start/stop button clicked.");b.preventDefault();switch(e.dataset.state){case"new":case"recorded":j();break;case"recording":m();break;}});this.uploadMediaToServer=function(){y("uploadpreparing");var a=new XMLHttpRequest;a.open("GET",c.src);a.responseType="blob";a.addEventListener("load",t);a.send()};function j(){if(b.hidePlayerDuringRecording){c.parentElement.classList.add("hide");d.classList.remove("hide");d.textContent="\xA0"}else{c.parentElement.classList.remove("hide");d.classList.add("hide")}e.classList.remove("btn-outline-danger");e.classList.add("btn-danger");C();H=[];I=0;a.debug("Audio/video question: Starting recording with media constraints");a.debug(b.mediaConstraints);navigator.mediaDevices.getUserMedia(b.mediaConstraints).then(k).catch(o)}function k(d){F=d;var f=A();a.debug("Audio/video question: creating recorder with opptions");a.debug(f);G=new MediaRecorder(d,f);G.ondataavailable=l;G.onstop=n;a.debug("Audio/video question: starting recording.");G.start(1e3);c.srcObject=d;c.muted=!0;if(!b.hidePlayerDuringRecording){c.play();c.controls=!1}e.dataset.state="recording";p();e.disabled=!1;e.focus()}function l(b){a.debug("Audio/video question: chunk of "+b.data.size+" bytes received.");I+=b.data.size;if(0<=h.maxUploadSize&&I>=h.maxUploadSize){if(!localStorage.getItem("alerted")){localStorage.setItem("alerted","true");m();g.showAlert("nearingmaxsize")}else{localStorage.removeItem("alerted")}}H.push(b.data);if("undefined"!=typeof M.core_formchangechecker&&!window.location.pathname.endsWith("/question/preview.php")){M.core_formchangechecker.set_form_changed()}}function m(){e.disabled=!0;q();e.classList.remove("btn-danger");e.classList.add("btn-outline-danger");a.debug("Audio/video question: stopping recording.");G.stop();for(var b=F.getTracks(),c=0;c<b.length;c++){b[c].stop()}}function n(){if("new"===e.dataset.state){return}a.debug("Audio/video question: recording stopped.");var b=new Blob(H,{type:G.mimeType});c.srcObject=null;c.src=URL.createObjectURL(b);c.muted=!1;c.controls=!0;c.parentElement.classList.remove("hide");d.classList.add("hide");c.focus();e.disabled=!0;e.classList.remove("btn-danger");e.classList.add("btn-outline-danger");e.dataset.state="recorded";if(0<H.length){g.notifyRecordingComplete(E)}}function o(b){a.debug("Audio/video question: error received");a.debug(b);z("recordingfailed");y("recordagain");e.classList.remove("btn-danger");e.classList.add("btn-outline-danger");e.dataset.state="new";if(G){G.stop()}var c="gum"+b.name.replace("Error","").toLowerCase();g.showAlert(c);B()}function p(){J=h.timeLimit;r();K=setInterval(r,1e3)}function q(){if(0!==K){clearInterval(K);K=0}}function r(){var a=J%60,b=Math.round((J-a)/60);y("recordinginprogress",s(b)+":"+s(a));if(-1===J){m()}J-=1}function s(a){var b=a+"";if(2>b.length){return"0"+b}else{return b}}function t(a){var b=a.target;if(200!==b.status){return}var c=b.response,d=new FormData;d.append("repo_upload_file",c,f);d.append("sesskey",M.cfg.sesskey);d.append("repo_id",h.uploadRepositoryId);d.append("itemid",h.draftItemId);d.append("savepath","/");d.append("ctx_id",h.contextId);d.append("overwrite",1);var e=new XMLHttpRequest;e.addEventListener("readystatechange",u);e.upload.addEventListener("progress",v);e.addEventListener("error",w);e.addEventListener("abort",x);e.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload");e.send(d)}function u(a){var b=a.target;if(4===b.readyState&&200===b.status){y("recordagain");B()}else if(404===b.status){z("uploadfailed404");B()}}function v(a){y("uploadprogress",Math.round(100*(a.loaded/a.total))+"%")}function w(){z("uploadfailed");B()}function x(){z("uploadaborted");B()}function y(b,c){e.innerText=M.util.get_string(b,"qtype_recordrtc",c)}function z(b,e){d.textContent=M.util.get_string(b,"qtype_recordrtc",e);c.parentElement.classList.add("hide");d.classList.remove("hide")}function A(){var a={};if("audio"===b.name){a.audioBitsPerSecond=parseInt(h.audioBitRate,10)}else if("video"===b.name){a.videoBitsPerSecond=parseInt(h.videoBitRate,10);a.videoWidth=parseInt(h.videoWidth,10);a.videoHeight=parseInt(h.videoHeight,10)}for(var c=0;c<b.mimeTypes.length;c++){if(MediaRecorder.isTypeSupported(b.mimeTypes[c])){a.mimeType=b.mimeTypes[c];break}}return a}function B(){D(!0);g.notifyButtonStatesChanged()}function C(){D(!1)}function D(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:!1;i.querySelectorAll("button, input[type=submit], input[type=button]").forEach(function(b){b.disabled=!a})}}function e(){this.name="audio";this.hidePlayerDuringRecording=!0;this.mediaConstraints={audio:!0};this.mimeTypes=["audio/webm;codecs=opus","audio/ogg;codecs=opus"]}function f(a,b){this.name="video";this.hidePlayerDuringRecording=!1;this.mediaConstraints={audio:!0,video:{width:{ideal:a},height:{ideal:b}}};this.mimeTypes=["video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/webm;codecs=vp8,opus"]}function g(a,g){var k=document.getElementById(a),l=c();if("nothttps"===l){k.querySelector(".https-warning").classList.remove("hide");return}else if("nowebrtc"===l){k.querySelector(".no-webrtc-warning").classList.remove("hide");return}var m=k.querySelectorAll(".audio-widget, .video-widget");m.forEach(function(a){var b=a.dataset.mediaType,c=a.querySelector(".record-button button"),l=a.querySelector(".media-player "+b),m=a.querySelector(".no-recording-placeholder"),n=a.dataset.recordingFilename,o;if("audio"===b){o=new e}else{o=new f(g.videoWidth,g.videoHeight)}this.showAlert=i;this.notifyRecordingComplete=j;this.notifyButtonStatesChanged=h;new d(o,l,m,c,n,this,g,k)});h();function h(){var a=!1;k.querySelectorAll(".audio-widget, .video-widget").forEach(function(b){if("recorded"===b.querySelector(".record-button button").dataset.state){a=!0}});var b=k.querySelector("input.submit[type=submit]");if(b){b.disabled=!a}}function i(a){return b.create({type:b.types.ALERT,title:M.util.get_string(a+"_title","qtype_recordrtc"),body:M.util.get_string(a,"qtype_recordrtc")}).then(function(a){a.show();return a})}function j(a){a.uploadMediaToServer()}}return{init:function init(a,b){M.util.js_pending("init-"+a);new g(a,b);M.util.js_complete("init-"+a)}}});
//# sourceMappingURL=avrecording.min.js.map
